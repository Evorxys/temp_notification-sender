<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Flask Notification PWA</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#000000">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="container">
    <h1>üì± Flask PWA Notification App</h1>
    <p>Works offline and sends notifications.</p>
    <p>‚è∞ Next notification in: <span id="countdown">10</span> seconds</p>
    <button id="manualNotify">Show Notification Now</button>
  </div>

<script>
let countdownTime = 10;
const countdownDisplay = document.getElementById("countdown");

async function registerServiceWorker() {
  if ('serviceWorker' in navigator) {
    try {
      const reg = await navigator.serviceWorker.register('/sw.js');
      console.log("‚úÖ Service Worker registered:", reg);
    } catch (err) {
      console.error("‚ùå SW registration failed:", err);
    }
  }
}

async function requestPermission() {
  const permission = await Notification.requestPermission();
  console.log("Permission:", permission);
  return permission;
}

async function showNotification(title, body) {
  const reg = await navigator.serviceWorker.getRegistration();
  if (reg) {
    reg.showNotification(title, {
      body: body,
      icon: "https://cdn-icons-png.flaticon.com/512/1827/1827370.png",
      vibrate: [200, 100, 200]
    });
  }
}

function startCountdown() {
  const timer = setInterval(() => {
    countdownTime--;
    countdownDisplay.textContent = countdownTime;
    if (countdownTime === 0) {
      showNotification("‚è∞ Timed Notification", "This is your timed alert (works offline)!");
      clearInterval(timer);
    }
  }, 1000);
}

document.addEventListener("DOMContentLoaded", async () => {
  await registerServiceWorker();
  const permission = await requestPermission();

  if (permission === "granted") {
    startCountdown();
  }

  document.getElementById("manualNotify").addEventListener("click", () => {
    showNotification("üì¢ Manual Notification", "You clicked the button!");
  });
});
</script>
</body>
